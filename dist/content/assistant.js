(function(){const e="[PibbleContent]",g=window===window.top;console.log("🟢 🟢 🟢 CONTENT SCRIPT LOADING 🟢 🟢 🟢"),console.log(e,"Script file executed!"),console.log(e,"URL:",location.href),console.log(e,"Frame type:",g?"TOP FRAME":"IFRAME"),console.log(e,"Timestamp:",new Date().toISOString());let i=!1;function d(){if(window.__pibbleBridgeInjected)return;console.log(e,"Injecting page bridge script...");const t=document.createElement("script");t.src=chrome.runtime.getURL("injected/pageBridge.js"),t.onload=()=>{console.log(e,"✅ Page bridge script loaded"),t.remove(),setTimeout(()=>{i=!0,console.log(e,"✅ Bridge ready for requests")},500)},t.onerror=()=>{console.error(e,"❌ Failed to load page bridge script")},window.__pibbleBridgeInjected=!0,document.documentElement.appendChild(t)}d();const a=new Map;window.addEventListener("message",t=>{if(t.source!==window)return;const o=t.data;if(!(!o||typeof o!="object")&&o.type==="PBRIDGE_RESPONSE"&&o.requestId){console.log(e,"Received PBRIDGE_RESPONSE for",o.requestId);const n=a.get(o.requestId);n&&(n({text:o.text,error:o.error}),a.delete(o.requestId))}});function p(t,o){console.log(e,`bridgePrompt() called for ${o}`);const n=`req-${Date.now()}-${Math.random().toString(36).slice(2)}`;return console.log(e,`🤖 Sending to AI, requestId: ${n}`),console.log(e,`📝 Mode: ${o}, text length: ${t.length} chars`),new Promise((r,s)=>{const c=setTimeout(()=>{a.delete(n),console.error(e,`❌ AI timeout for requestId: ${n}`),s(new Error("AI timeout"))},6e4);a.set(n,l=>{clearTimeout(c),l.error?(console.error(e,`❌ AI error: ${l.error}`),s(new Error(l.error))):(console.log(e,`✅ AI response received for requestId: ${n}`),r(String(l.text??"")))}),console.log(e,"Posting PBRIDGE_REQUEST to window"),window.postMessage({type:"PBRIDGE_REQUEST",requestId:n,payload:{userText:t,mode:o}},"*")})}async function w(){console.log(e,"🔍 Getting text from clipboard...");try{const t=await navigator.clipboard.readText();if(t&&t.trim())return console.log(e,`✅ Got ${t.length} chars from clipboard`),t.trim()}catch(t){console.error(e,"❌ Clipboard read failed:",t)}return console.log(e,"❌ No text in clipboard"),""}function u(){const o=document.querySelector('main, article, [role="main"]')||document.body;return(o.innerText||o.textContent||"").trim()}async function m(t){console.log(e,`
${"═".repeat(80)}`),console.log(e,`🎯 🎯 🎯 ${t.toUpperCase()} ACTION TRIGGERED 🎯 🎯 🎯`),console.log(e,`${"═".repeat(80)}`);try{if(!i){console.warn(e,"⚠️ Bridge not ready yet, waiting..."),window.postMessage({type:"PIBBLE_STATUS",message:"⏳ Initializing AI..."},"*");let s=0;for(;!i&&s<20;)await new Promise(c=>setTimeout(c,100)),s++;if(!i)throw new Error("AI initialization timeout")}let o="";if(t==="summarize"){if(console.log(e,"📄 Extracting page text for summarization..."),o=u(),!o)throw new Error("No text found on page");console.log(e,`✅ Extracted ${o.length} chars from page`)}else{if(o=await w(),!o){console.error(e,"❌ NO TEXT IN CLIPBOARD!"),window.postMessage({type:"PIBBLE_STATUS",message:"⚠️ Please copy text first"},"*");return}console.log(e,`✅ Got text: ${o.length} characters`)}const n=t==="proofread"?"Proofreading":t==="rewrite"?"Rewriting":"Summarizing page";window.postMessage({type:"PIBBLE_STATUS",message:`⚙️ ${n}...`},"*"),window.parent&&window.parent!==window&&window.parent.postMessage({type:"PIBBLE_STATUS",message:`⚙️ ${n}...`},"*"),console.log(e,`🤖 Calling ${t} API...`);const r=await p(o,t);console.log(e,`
${"─".repeat(80)}`),console.log(e,`✨ ✨ ✨ ${t.toUpperCase()} RESULT ✨ ✨ ✨`),console.log(e,`Result length: ${r.length} characters`),console.log(e,`${"─".repeat(80)}`),console.log(e,r),console.log(e,`${"─".repeat(80)}
`),window.postMessage({type:"PIBBLE_RESULT",text:r,mode:t},"*"),window.parent&&window.parent!==window&&window.parent.postMessage({type:"PIBBLE_RESULT",text:r,mode:t},"*"),window.postMessage({type:"PIBBLE_STATUS",message:"✅ Done! Click copy to use result"},"*"),window.parent&&window.parent!==window&&window.parent.postMessage({type:"PIBBLE_STATUS",message:"✅ Done! Click copy to use result"},"*")}catch(o){console.error(e,"❌ ❌ ❌ ERROR during AI action:",o);const n=o instanceof Error?o.message:String(o);window.postMessage({type:"PIBBLE_STATUS",message:`❌ ${n}`},"*"),window.parent&&window.parent!==window&&window.parent.postMessage({type:"PIBBLE_STATUS",message:`❌ ${n}`},"*")}finally{console.log(e,`${"═".repeat(80)}`),console.log(e,`✓ ${t.toUpperCase()} ACTION COMPLETE`),console.log(e,`${"═".repeat(80)}

`)}}window.addEventListener("message",t=>{const o=t.data;if(!(!o||typeof o!="object")&&o.type==="PIBBLE_ACTION"){const n=o.mode;console.log(e,`📨 📨 📨 Received PIBBLE_ACTION message, mode: ${n}`),n==="proofread"||n==="rewrite"||n==="summarize"?m(n):console.warn(e,`⚠️ Unknown mode: ${n}`)}}),console.log(e,"🎧 Message listener registered for PIBBLE_ACTION"),console.log(e,`✅ ✅ ✅ Content script FULLY READY (frame: ${g?"TOP":"iframe"})`),console.log(e,"Waiting for PIBBLE_ACTION messages...")})();
