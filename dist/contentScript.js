(function(){const a="[PibbleContent]";console.debug(a,"loaded on",location.href);function u(){if(window.__pibbleBridgeInjected)return;const e=document.createElement("script");e.src=chrome.runtime.getURL("injected/pageBridge.js"),e.onload=()=>e.remove(),window.__pibbleBridgeInjected=!0,document.documentElement.appendChild(e)}const c=new Map;window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object")&&t.type==="PBRIDGE_RESPONSE"&&t.requestId){const o=c.get(t.requestId);o&&(o({text:t.text,error:t.error}),c.delete(t.requestId))}});function f(e){u();const t=`req-${Date.now()}-${Math.random().toString(36).slice(2)}`;return new Promise((o,n)=>{const i=setTimeout(()=>{c.delete(t),n(new Error("Timed out waiting for pageBridge"))},3e4);c.set(t,r=>{clearTimeout(i),r.error?n(new Error(r.error)):o(String(r.text??""))}),window.postMessage({type:"PBRIDGE_REQUEST",requestId:t,prompt:e},"*")})}function w(){const e=window.getSelection();return!e||e.rangeCount===0?{text:""}:{text:e.toString(),range:e.getRangeAt(0)}}function m(e,t){return e==="proofread"?`Proofread the following text. Fix grammar, spelling, and clarity. Keep meaning and tone. Return only the corrected text.

---
${t}`:`Rewrite the following text to be clearer and more concise while preserving meaning and voice. Return only the rewritten text.

---
${t}`}async function p(e,t){var i,r;if(e.commonAncestorContainer instanceof Element?(r=(i=e.commonAncestorContainer).closest)==null?void 0:r.call(i,'[contenteditable="true"]'):null)return e.deleteContents(),e.insertNode(document.createTextNode(t)),!0;const n=document.activeElement;if(n&&(n.tagName==="TEXTAREA"||n.tagName==="INPUT"&&n.type==="text")){const s=n.selectionStart??0,g=n.selectionEnd??s,l=n.value;return n.value=l.slice(0,s)+t+l.slice(g),n.dispatchEvent(new Event("input",{bubbles:!0})),!0}return!1}async function d(e){try{const{text:t,range:o}=w();if(!t.trim())return;const n=await f(m(e,t));(o?await p(o,n):!1)||await navigator.clipboard.writeText(n)}catch(t){console.warn(a,"AI error",t)}}chrome.runtime.onMessage.addListener(e=>{(e==null?void 0:e.type)==="AI_PROOFREAD"&&d("proofread"),(e==null?void 0:e.type)==="AI_REWRITE"&&d("rewrite")})})();
