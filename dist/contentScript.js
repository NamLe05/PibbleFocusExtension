(function(){const c="[PibbleContent]";console.debug(c,"loaded on",location.href);function f(){if(window.__pibbleBridgeInjected)return;const e=document.createElement("script");e.src=chrome.runtime.getURL("injected/pageBridge.js"),e.onload=()=>e.remove(),window.__pibbleBridgeInjected=!0,document.documentElement.appendChild(e)}const i=new Map;window.addEventListener("message",e=>{if(e.source!==window)return;const t=e.data;if(!(!t||typeof t!="object")&&(t.type==="PBRIDGE_RESPONSE"||t.type==="PBRIDGE_PONG")){const o=i.get(t.requestId);o&&(console.debug(c,"received",t.type,t.info??""),o({text:t.text,error:t.error,info:t.info}),i.delete(t.requestId))}});function w(e){f();const t=`${Date.now()}-${Math.random().toString(36).slice(2)}`;return new Promise((o,n)=>{const a=setTimeout(()=>{i.delete(t),n(new Error("Timed out"))},3e4);i.set(t,r=>{clearTimeout(a),r!=null&&r.error?n(new Error(r.error)):o(String((r==null?void 0:r.text)??""))}),window.postMessage({type:"PBRIDGE_REQUEST",requestId:t,payload:{userText:e}},"*")})}function E(){const e=window.getSelection();return!e||e.rangeCount===0?{text:""}:{text:e.toString(),range:e.getRangeAt(0)}}function p(e,t){return e==="proofread"?`Proofread the following text. Fix grammar, spelling, and clarity. Keep meaning and tone. Return only the corrected text.

---
${t}`:`Rewrite the following text to be clearer and more concise while preserving meaning and voice. Return only the rewritten text.

---
${t}`}async function b(e,t){var a,r;if(e.commonAncestorContainer instanceof Element?(r=(a=e.commonAncestorContainer).closest)==null?void 0:r.call(a,'[contenteditable="true"]'):null)return e.deleteContents(),e.insertNode(document.createTextNode(t)),!0;const n=document.activeElement;if(n&&(n.tagName==="TEXTAREA"||n.tagName==="INPUT"&&n.type==="text")){const l=n.selectionStart??0,R=n.selectionEnd??l,s=n.value;return n.value=s.slice(0,l)+t+s.slice(R),n.dispatchEvent(new Event("input",{bubbles:!0})),!0}return!1}async function d(e){try{const{text:t,range:o}=E();if(!t.trim())return;const n=await w(p(e,t));(o?await b(o,n):!1)||await navigator.clipboard.writeText(n)}catch(t){console.warn("[PibbleAssistant]",t)}}function u(e,t,o){const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`;i.set(n,o),console.debug(c,"forwarding",e,"requestId=",n),window.postMessage({type:e,requestId:n,payload:t},"*")}chrome.runtime.onMessage.addListener((e,t,o)=>{if((e==null?void 0:e.type)==="PROMPT_TEXT")return u("PBRIDGE_REQUEST",{userText:e.userText,systemPrompt:e.systemPrompt??null,temperature:e.temperature??.7},o),!0;if((e==null?void 0:e.type)==="BRIDGE_PING")return u("PBRIDGE_PING",{},o),!0;(e==null?void 0:e.type)==="AI_PROOFREAD"&&d("proofread"),(e==null?void 0:e.type)==="AI_REWRITE"&&d("rewrite")})})();
